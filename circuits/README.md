# SovereignCV ZK (Agent D)

Primary circuit:

- `circuits/verifySovereignCV.circom`

Artifacts generated by the scripts:

- `circuits/artifacts/verifySovereignCV.r1cs`
- `circuits/artifacts/verifySovereignCV_js/verifySovereignCV.wasm`
- `circuits/artifacts/verifySovereignCV_final.zkey`
- `circuits/artifacts/verification_key.json`
- `contracts/Groth16Verifier.sol`

Public signals (frozen order):

1. `requiredSkillHash`
2. `minExperienceMonths`
3. `educationCommitment`
4. `employmentCommitment`
5. `result`

## What The Circuit Enforces

1. Education:
- provider code is one of `[1, 2, 3, 4]`
- certificate issue time is non-zero
- certificate is not expired (`expiry >= issuedAt`)
- certificate skill hash matches `requiredSkillHash`
- `certificateWitnessHash` is bound to certificate witness fields with Poseidon
- `educationCommitment` is bound to witness values with Poseidon
- public policy/commitment signals are mirrored to private policy fields and square-bound

2. Employment:
- employer registration and token allowlist flags are both true
- each of 3 months has at least one transfer
- months are consecutive (`m1 = m0 + 1`, `m2 = m1 + 1`)
- `employmentExperienceMonths >= minExperienceMonths`
- `employmentCommitment` is bound to witness values with Poseidon
- public policy/commitment signals are mirrored to private policy fields and square-bound

3. Result:
- `result = educationSatisfied * employmentSatisfied`
- `result` must be `1` for a valid witness

Constraint details are in `circuits/CONSTRAINT_SUMMARY.md`.

## Reproducible Commands

1. Generate deterministic inputs:

```bash
npm run zk:inputs
```

Real-data input generation (no mock vectors):

```bash
npm run zk:inputs:real -- --wallet 0x... --fdc-request-id <uuid> --required-skill-hash <uint> --min-experience-months <uint> --salary-commitment <uint> --education-expiry-at <unix> --employment-experience-months <uint> --out circuits/inputs/real.json
```

You can also pass `--attestation-id 0x...` instead of `--fdc-request-id`.
This command pulls:
1. education attestation from `AttestationStorage` on `FLARE_RPC_URL`
2. transfer logs from `PLASMA_RPC_URL` for `STABLECOIN_ALLOWLIST`
3. employer registration from `EmployerRegistry`
and writes a witness input + metadata file.

2. Build Groth16 artifacts + export Solidity verifier:

```bash
npm run zk:build
```

3. Generate valid witness/proof/public/calldata:

```bash
npm run zk:prove
```

4. Run vector checks required by Agent D done criteria:

```bash
npm run zk:check
```

`zk:check` asserts:

1. Valid witness verifies.
2. Tampered public signal fails verification.
3. Missing-month witness fails generation.
4. Invalid-cert witness fails generation.

## On-Chain Verifier Handoff

1. `contracts/Groth16Verifier.sol` is generated by `snarkjs zkey export solidityverifier`.
2. `contracts/Groth16VerifierAdapter.sol` adapts packed proof bytes to the generated verifier ABI expected by `CVVerifier.sol`.
3. `scripts/deploy.ts` deploys `Groth16Verifier` and `Groth16VerifierAdapter` when `GROTH16_VERIFIER_ADDRESS` is not provided.

## Local Runtime Note

Hardhat currently warns that Node.js `v25` is unsupported. `npm run zk:check` is the source of truth for proof correctness in this environment.
